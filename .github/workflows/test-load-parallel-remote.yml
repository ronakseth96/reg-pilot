name: Remote Mode load test
on:
  push:
    branches:
      - feature/load-test-parallel
  workflow_dispatch:

jobs:
  remote-test:
    runs-on: macos-latest
    defaults:
      run:
        working-directory: signify-ts-test/

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Docker (for macOS)
        run: |
          brew install --cask docker
          sudo /Applications/Docker.app/Contents/MacOS/Docker --quit-after-install --unattended || true
          nohup /Applications/Docker.app/Contents/MacOS/Docker --unattended &
          # open -a Docker
          echo "Waiting for Docker to start..."

          # Retry logic for Docker initialization
          retries=5
          while [ $retries -gt 0 ]; do
            if docker --version; then
              echo "Docker is ready!"
              break
            else
              echo "Waiting for Docker to start... $retries retries left"
              retries=$((retries - 1))
              sleep 10 
            fi
          done

          if [ $retries -eq 0 ]; then
            echo "Docker failed to start after multiple retries. Exiting."
            exit 1
          fi

      - name: Install dependencies
        run: |
          npm cache clean --force
          npm set registry https://registry.npmjs.org/
          npm ci

      - name: Run test-load-parallel script for the staging process
        run: |
          chmod +x test-load-parallel.sh
          ./test-load-parallel.sh --mode remote --first-bank 1 --bank-count 5 --api-url https://reg-api-test.rootsid.cloud --stage

      - name: Run test-load script for remote workflow
        if: success()
        run: |
          chmod +x test-load-parallel.sh
          ./test-load-parallel.sh --mode remote --first-bank 1 --bank-count 5 --batch-size 2 --api-url https://reg-api-test.rootsid.cloud --fast
